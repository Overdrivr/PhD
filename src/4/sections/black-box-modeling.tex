\section{Black box modeling approach}

% Motivation for a black box model of the complete circuit
The goal of the black-box modeling method is to build a combined electrical and failure model of an integrated function between two external pins.
This model is developped to allow third-parties that don't have access to the integrated circuit design to perform ESD simulations of a board containing integrated circuits.
The electrical part of the model serves to run the \gls{spice} simulations.
The failure part of the model watches the external input pin and detects conditions that would lead to a failure visible on the external output pin.
The black box model is somehow intented to act as a replacement for the complete \gls{ic} circuit for \gls{esd} board-level simulations.
This approach follows the recommendation of the \gls{seed} methodology \cite{seed} presented earlier.
The \gls{seed} methodology normally applies to hard-failure, but in this chapter the concept is pushed further with soft-failures.
\gls{seed} recommends that the ESD robustness of a system should be handled by a collaboration between the board and the integrated circuit.
To achieve this, it is necessary to have simulation tools capable of simulating both elements at the same time.
The black-box model presented in this chapter is a potential solution to this issue.
It does not reveal the internal IC design while allowing complete simulations of board and integrated circuits to predict soft-failures.
It also abstracts the internal complexity of the integrated circuit design, allowing significantly faster simulations and less convergence issues.
Of course, the downside is a loss of accuracy for the simulations, but that can remain acceptable for ESD analysis.

% What is the model
As previously described, the model contains a failure element and two electrical models \ref{fig:black-box-principle}.
The input port model reproduces the behavior of the integrated circuit between the external input pin and (usually) a ground pin.
The failure model watches for voltage or current on the input port, compares those parameters to the failure characterization and deduces if the input was sufficiently disturbed to create a fault.
Then, it transfer that information to the output port model, that changes behavior in case of fault or remains in its DC state in the absence of a failure.

\begin{figure}[!h]
  \centering
  \includegraphics[width=0.6\textwidth]{src/4/figures/black_box_model_principle.pdf}
  \caption{Black-box model principle}
  \label{fig:black-box-principle}
\end{figure}

% How is the model constructed
The failure model is extracted first, using a set of variable amplitude and width rectangular pulses applied on the input pin while monitoring the output pin.
After this step, the robustness of the function against this range of stresses is known.
A curve is built that describes the failure of the output when an input is stressed.
The second step is to electrically model both the input and the output ports.
Initially, a \gls{tlp} characterization of each port is performed to extract an equivalent I(V) curve.
Since the circuit is stressed while being powered and in operation, it is studied afterward if this extraction should occur on a device powered as well or not, and what is the impact of the supply on the extracted curve.
This characterization is based on the hypothesis that the quasi-static I(V) curve could be suitable for reproducing the behavior of the port both in DC and transient domain.
It will be demonstrated afterward that this hypothesis is not completely true and an alternative approach is required for the output pin.
This I(V) curve is converted in an electrical model using a piecewise-linear curve described in Verilog-A modelling language.
Finally, once the two electrical models and the failure model have been constructed, it can be possible to join all the parts together to build the complete IC model.
The concept was not tested entirely in simulation because of some issues discovered late, but using a particular setup it is possible to build it as follow-up work.
The next part of this chapter details further the modelling approach and all the issues met during the developpement as well as possible improvements.

\subsection{Function failure model}

% How is the characterization conducted
Once again, a variable width/variable amplitude rectangular pulses are applied on an input pin.
The output pin is then observed to detect for which input parameters it is going out of specification.

% What is characterized
This characterization is performed on the testchip, on the complete regulation function.
The characterization pulses are injected on the $V_{batt}$ input.
The output pin is $V_{2p5}$, the regulated supply.
It is supposed to deliver a 2.5V regulated supply.
The failure criteria is set at a voltage below 2.1V.
It corresponds to a level below which digital cells powered by this supply will have noise margins too small for proper operation.

% Fig X shows the waveform of the VBAT injected current when stressed with a TLP (square) impulse.
% The TLP waveform before the capacitor is shown for reference.
%TODO: WAVEFORM CURRENT VBAT AND TLP BEFORE INJECTION CAPACITOR ?

% Detail the characterization
The characterization table is plotted in Fig. \ref{fig:cz-black-box}.
X-axis is the pulse width, and y-axis is the minimal stress amplitude that caused a failure on the output.

\begin{figure}[!h]
  \centering
  \includegraphics[width=\textwidth]{src/4/figures/black_box_regulator.png}
  \caption{Black-box characterization of the regulation function}
  \label{fig:cz-black-box}
\end{figure}

% What to do with that
%TODO: We that below this value the function is in fail, etc
However, the motivation for this model is to replace the transistor-level schematic inside a SPICE simulation at board-level.
Given a pulse width and an amplitude on $V_{batt}$, the model can estimate the disturbance amplitude and width on $V_{2p5}$.
However, the model itself is not an electrical model, only a failure model.
It cannot determinate, given for instance an input voltage, how much current is flowing into it.
This is also true for the output.
Thus, this method calls for an electrical model of \gls{io}.
The next section details how to solve this issue.

\subsection{Electrical pin models}

%TODO: Review everything hereafter
An electrical modelling method for silicon functions is explored.
Ideally, the model could replace any function's input or output, be extracted and configured easily.
We formulate the initial hypothesis that \gls{io}s can be modeled by their extracted TLP characteristic, representing their quasi-static I(V) response.

% powered or unpowered conditions ?
Extracting the \gls{tlp} characteristic can be bone with the device powered or unpowered.
Unpowered condition is the simplest case, because the characterization can be performed without external components.
In powered conditions, the characterization is more challenging, because for the device to be functional, external devices can be required.
Yet they are not wanted in the characterization.

% Comparison to decide
To decide the best approach, \gls{tlp} characterizations are performed on the testchip's regulation function, in powered and unpowered conditions.
For powered conditions, it is considered that full functionality and performance does not matter, just the equivalent impedance of the input or output.
As a consequence, the function is biased but external devices are not connected.
Unpowered and powered characterizations are compared respectively in Fig. \ref{fig:tlp-input-cz} and \ref{fig:tlp-output-cz}.

\begin{figure}[!h]
  \centering
  \includegraphics[width=\textwidth]{src/4/figures/tlp_input_characterization.png}
  \caption{TLP characterization of function input in powered and unpowered conditions}
  \label{fig:tlp-input-cz}
\end{figure}

\begin{figure}[!h]
  \centering
  \includegraphics[width=\textwidth]{src/4/figures/tlp_output_characterization.png}
  \caption{TLP characterization of function output in powered and unpowered conditions}
  \label{fig:tlp-output-cz}
\end{figure}

For both input and output ports, large differences are observed between powered and unpowered modes.
Different amount of current are absorbed by the device in each conditions.
Since the model is intended for powered-on simulations, the characterization in powered conditions is chosen.

% Explain the PWL model
The second step of the modelling method is to build an electrically simulatable model of the function.
A piecewise linear model seems well suited for this situation.
Specifically, a configurable four-points piecewise linear model is written in Verilog-A (see Listing \ref{lst:pwl-4pts}).
The model is configured easily with 4 four (V\textsubscript{i},I\textsubscript{i}) coordinates.

\begin{code}
\inputminted[frame=single]{verilog}{src/4/snippets/pwl_4pts.va}
\caption{Piecewise linear 4-points Verilog-A model}
\label{lst:pwl-4pts}
\end{code}


% Comment the model
For this kind of model to work, a few rules of thumbs must be followed.
First, convergence can be difficult to achieve if the piecewise-linear curve is not continuous at order 0.
Electrically speaking, it would be equivalent to very abruptly switching the value of a resistor for instance.
%TODO: SOA gloss
For our particular case, I(V) curves are extracted for a wide range of voltages.
However, integrated function are being characterized and not ESD protections.
Any part of the curve above Safe-Operating Areas is irrelevant for this functional model, since beyond it the function is destroyed.
Therefore, it is important to fit the curve inside and near the nominal operating area.
For the input, the model should be accurate between -10V and 40V.
%TODO: Speak about resistance value near 0V versus matching overall curve shape

% Validate the model with TLP
The verilog-a model is first tested against the complete schematic for the function's input.

\begin{figure}[!h]
  \centering
  \includegraphics[width=\textwidth]{src/4/figures/testbench_blackbox_input.png}
  \caption{Testbench for comparing omplete schematic with input model simulations}
  \label{fig:compare-model-simu-m10}
\end{figure}

After issues described previously were solved, good agreement is achieved between model and complete circuit.
This was verified at -10V, 20V and 40V TLP amplitude (Fig. \ref{fig:compare-model-simu-m10}, Fig. \ref{fig:compare-model-simu-20}, Fig. \ref{fig:compare-model-simu-40}).
The model is considered mostly valid for the input.

\begin{figure}[!h]
  \centering
  \includegraphics[width=\textwidth]{src/4/figures/comparison_model_total_m10V.png}
  \caption{Comparison of complete schematic and model simulations for input port (-10V TLP)}
  \label{fig:compare-model-simu-m10}
\end{figure}

\begin{figure}[!h]
  \centering
  \includegraphics[width=\textwidth]{src/4/figures/comparison_model_total_20V.png}
  \caption{Comparison of complete schematic and model simulations for input port (-20V TLP)}
  \label{fig:compare-model-simu-20}
\end{figure}

\begin{figure}[!h]
  \centering
  \includegraphics[width=\textwidth]{src/4/figures/comparison_model_total_40V.png}
  \caption{Comparison of complete schematic and model simulations for input port (-40V TLP)}
  \label{fig:compare-model-simu-40}
\end{figure}

% Check the output
The same test is performed for the function's output model.

\begin{figure}[!h]
  \centering
  \includegraphics[width=\textwidth]{src/4/figures/comparison_model_total_output_m10V.png}
  \caption{Comparison of complete schematic and model simulations for output port (-10V TLP)}
  \label{fig:compare-model-simu-m10}
\end{figure}

\begin{figure}[!h]
  \centering
  \includegraphics[width=\textwidth]{src/4/figures/comparison_model_total_output_20V.png}
  \caption{Comparison of complete schematic and model simulations for output port (-20V TLP)}
  \label{fig:compare-model-simu-20}
\end{figure}

\begin{figure}[!h]
  \centering
  \includegraphics[width=\textwidth]{src/4/figures/comparison_model_total_output_40V.png}
  \caption{Comparison of complete schematic and model simulations for output port (-40V TLP)}
  \label{fig:compare-model-simu-40}
\end{figure}

%TODO
The situation is more complex in this case.
The output model must perform three tasks.
First, offer an output impedance close the the one of the real function.
Second, provide a DC value, here corresponding to the regulated 2.5V.
Lastly, reproduce the function reset where the output voltage falls down then restarts.
A first output model is envisionned (Fig. \ref{fig:first-output-model}).

\begin{figure}[!h]
  \centering
  \includegraphics[width=0.3\textwidth]{src/4/figures/first_output_model.png}
  \caption{First proposal for modeling function output}
  \label{fig:first-output-model}
\end{figure}

% Is this first model working
Preliminary and extended tests show that this configuration is not working.
Ultimately, the I(V) curve Verilog-A model is a voltage-controlled current source.
When the model is combined with the external devices, several issues arise.
%TODO: Fig
Fig. X shows such a configuration.

\subsection{Combining failure and electrical models}

% What is the complete model
The complete function model combines the input piecewise-linear model, the failure model, the output piecewise-linear model, and an output DC source (for settling nominal value).

Fig. \ref{fig:complete-black-box-model}
The failure model act as a voltage-controlled voltage source, controlled by the input, and acting on the output.
Given an disturbance amplitude and width and width on the input, it configures and generates a rectangular pulse on the output.

\begin{figure}[!h]
  \centering
  \includegraphics[width=0.3\textwidth]{src/4/figures/complete_black_box_model.pdf}
  \caption{Architecture of the complete black-box model}
  \label{fig:complete-black-box-model}
\end{figure}

% how is this model
To test the entire concept, two simulations are run.
The first one is the classic, transistor-level simulation of the function exposed to a (XX V, XXX ns) disturbance.
It serves as a reference.
The second simulation simulates only the output of the model.
The output failure source generates a rectangular pulse of (XXX V, XXX ns), corresponding to the same (XX V, XXX ns) disturbance on the input than the reference.
The goal is to verify if the model can reproduce even partially the disturbance on the output pin.

%TODO: Simulation

In conclusion, it can reproduce the variation on the output, for a given input disturbance.

\subsection{Conclusion on black-box modeling}

% Conclusion
Black box models of analog integrated functions are very interesting for distributing SPICE models to external parties.
They do not disclose the internal design of the chip, yet they can help achieve system-level ESD simulations.
Ultimately, the goal is to follow the SEED (TODO: Ref) methodology, that indicates that ESD robustness should not be handled at a single level of a system, but at every level (equipment, board, integrated circuit), and that all levels should work efficiently together toward that goal.
Black box models fit very nicely in this methodology.
In this section, a first technique for extracting and creating black-box models was presented.
There is a lot of room for improvements, but it is already working for some intermediate complex cases.
The core principle is that TLP characterization of inputs and ouputs on a biased function is sufficient to extract an equivalent impedance.
This impedance can replace the function in the schematic, during an ESD simulation, in order to reduce complexity and simulation time.
The second core principle is to simplify waveforms into rectangular ones in order to reduce the complexity of the problem.

% Opening work
There are many new leads to explore on these black box models.
First, behavior of the models against more time-varying disturbances such as ESD gun waveforms should be investigated.
Also, the piecewise-linear models should be improved to be more stable, and to fit more closely the extracted I(V) curve.
This technique should be applied to a wider number of analog functions, to observe if it can be used in a general manner.
For now, input and outputs must be simulated separately.
First, the input is simulated, then analyzed to extract the width and amplitude of the disturbance.
This data is then used to configure the output failure source pulse.
The model must be improved in order for the output to react in real-time to the disturbance of the input.
Ultimately, this calls for a Verilog-A model of the failure for instance, plus most likely an improved characterization method able to extract and describe this real-time behavior.

%TODO: need to validate with a varying waveform
