\subsection{Test vehicle description}

% Why making a testchip
It is difficult to realize good measurements on an integrated circuit.
The chip is enclosed in a package, and without physical access it is impossible to measure electrical properties.
Even with physical access, placing micro-probes to contact metal connections can disturb sensitive parts of the device.
To overcome these issues, it is interesting to develop custom structures that perform the measurements directly on the chip and output the data using standard \gls{io}.
For that matter, a custom test vehicle has been designed and manufactured.

% What is in the testchip
The testchip reuses most blocks from the Everest product described previously in \ref{sec:study-real-product}.
%TODO: What is monitored
In addition, custom functions were integrated to allow the measurement and monitoring of internal parameters.
A communication system was setup to output measurement data using a few pins.

% Why monitoring a primary supply
The studied function is the primary supply of a complex automotive \gls{asic}.
This supply plays a critical role in the functionning of the entire product.
It is connected to the battery of the vehicle, and is the first block of the product to start.
It wakes up and powers all other functions inside the integrated circuit.

% Global architecture
The global architecture of the testchip (Fig. \ref{architecture_testchip}) is comprised of a duplicated supply function.
The same supply block is instanciated twice on silicon.
One of them is the function under test, which is exposed to \gls{ESD} stresses and is monitored for failures.
The second one is responsible for powering the monitoring functions.
Both blocks are isolated from one another as much as possible.
The monitoring's supply is protected against disturbances to ensure good measurements.

\begin{figure}[h]
  \centering
  \includegraphics{src/3/figures/architecture_testchip.pdf}
  \caption{Global architecture of the test vehicle}
  \label{architecture_testchip}
\end{figure}

% What is in the monitoring system
The monitoring system is comprised of several functions.
The overvoltage and undervoltage detectors monitor several key voltages inside the supply under test.
There are in total 35 detectors in the testchip.
The communication function performs a parallel to serial conversion, in order to read and write a large amount of bits using just a few pins.
Special structures for specific monitoring functions is also implemented.
Details about the monitored and monitoring functions are given in the next sub-sections.

\subsection{Supply function under monitoring}

% Main task
The main function of the supply block is mostly to down-convert a battery voltage to a 2.5V regulated supply.
Several blocks are involved for processing the battery supply.
The overall architecture is given in fig. \ref{fig:monitored_function}).

% First block
First, a pre-regulator clamps the battery voltage that can reach 40V down to a 9V.
This is done to protect more sensitive circuits connected downstream.
This output has low current capability and is used for low-power functions.
A second output provides a 12V clamped output with a large current capability.

% Second block
A bandgap reference is connected downstream.
It is powered by the 9V supply.
Once properly started after a certain delay, the bandgap generates a 1.23 V voltage reference.
This reference is stable accross a wide range of temperature, process variation and process mismatchs.
The bandgap also outputs a 10uA current reference, and a flag \textit{bgok} to signal it is ready for operation.

\begin{figure}[!htbp]
  \centering
  \includegraphics[width=0.9\textwidth]{src/3/figures/monitored_function.pdf}
  \caption{Architecture of the supply under test}
  \label{fig:monitored_function}
\end{figure}

% Third major block
Finally, the \gls{ldo} regulator generates a stable 2.5V supply voltage, able to deliver and sustain up to 20mA.
In the original product, this output is used further in the system to power digital gates.

% Detail nets connections
The regulator relies on multiple signals generated in the upstream blocks for operation.
The most critical nets are the 1.0V reference from the bandgap, and the ramp-up signal.
Circuit analysis show that both nets can directly affect the output voltage.
A variation on the reference voltage is immediately copied on the output.
The ramp-up signal controls the soft-start of the regulator, that can directly change the output value.
Other nets provide bias to the regulator, and their impact on the output is more limited.

% Talk about external devices
The regulator is connected externally to a 100nF decoupling capacitor to absorb peak currents and achieve stability.

% What are the minor blocks doing
The \textit{current mirrors} provide copied current values from the bandgap, while offering much larger output impedance.
The \textit{enable} block mostly checks and waits for the bandgap to be properly started.
It then triggers a startup ramp-up sequence on the regulator.

\subsection{Voltage monitoring}

% What are the OV/UV detectors made of
Overvoltage and undervoltage detectors are implemented as latched comparators.
A flag is raised if a monitored net crosses a threshold, and stored using a latch, until it can be read.
The architecture of a single detector is given Fig. \ref{fig:architecture-ov}.
The same architecture is used for the overvoltage and the undervoltage.
Monitored and reference inputs are just inversed on the undervoltage detector.

\begin{figure}[!htbp]
  \centering
  \includegraphics[width=0.9\textwidth]{src/3/figures/architecture_OV.pdf}
  \caption{Architecture of the overvoltage detector}
  \label{fig:architecture-ov}
\end{figure}

% Detail architecture
The first block in this detector is the comparator.
It is designed with a two-stage operational amplifier with an output buffer (see Fig. \ref{fig:comparator-design}).
This topology is well suited for high-gain, open-loop comparators.
This comparator provides a very high output impedance, to ensure the monitored net is not disturbed.
A high-gain is useful for limiting the comparator's offset.
The performance of the comparator is given in table \ref{tab:comparator-performance}.
The critical factors are the high to low delay, to detect very fast transients, and the offset, to ensure detection accuracy is good.

\begin{figure}[!htbp]
  \centering
  \includegraphics[width=0.9\textwidth]{src/3/figures/comparator_design_clean.pdf}
  \caption{Comparator design}
  \label{fig:comparator-design}
\end{figure}

\begin{table}[!htbp]
\centering
\begin{tabular}{@{}lllll@{}}
\toprule
property           & specification & value (typical) \\
\midrule
offset             & +/- 10mV      & 2.65 mV \\
V(IH)              & +/- 10mV      & 1.15 mV \\
V(IL)              & +/- 10 mV     & 4.16 mV \\
delay low2high     & 50 ns         & 41 ns   \\
delay high2low     & 50 ns         & 12.8 ns \\
consumption (dc)   & 60 uA         & 33 uA \\
consumption (peak) & 350 uA        & 264 uA \\
\bottomrule
\end{tabular}
\caption{Comparator performance (typical)}
\label{tab:comparator-performance}
\end{table}


% What is the purpose of filter
On the output of the comparator, an optional RC filter can be connected.
This filter can deglitch very short overvoltages, to only let large overvoltages pass through the detector.
The stratety behind this filter is to use multiple detectors monitoring the same net, each one with a different filter.
In function of which detectors triggered, an estimation of the overvoltage length can be made.

% Hysteresis buffer
After the filter, an hysteresis buffer increases the deglitching action of the filter.
If the comparator's output remains high for a short period of time, the output of the filter will rise slowly.
If a standard buffer was used in place of the hysteresis buffer, it would latch at about half the supply voltage.
With the hysteresis, the buffer switches at a voltage much closer from the supply.
With the same RC filter, this results in a much longer deglitching time.
This was done because RC-filters require large resistors and large capacitors for integration on silicon, and occupy a considerable area on the chip.
By increasing the deglitching time, smaller RC-filters could be used.

% Latch
Finally, the latch stores the overvoltage flag.
By default, the latch is reset at `0`.
Its copy input `D` is connected to the supply.
If the hysteresis buffer triggers high, the enable pin will trigger a copy in the latch.
The output `Q` will copy the value from the input `D`, storing a logical high in the latch.

% Origin of reference voltages
The reference voltages for these comparators come from the protected supply.

\subsection{Communication system}

% What does the comm IO
The monitoring system also provides a bidirectionnal communication system.
It is designed to read with a single pin the values from the comparator register bank.
It also supports writing to a second register bank, that is used in the monitoring system for configuration.

%TODO: Detail

\subsection{On-chip near-field current sensors}

To be done
%TODO: Refer to PhD Alain
%TODO: Use document These/07
